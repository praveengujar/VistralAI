// VistralAI Prisma Schema for MongoDB
// This schema defines all 8 Brand 360 entities

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

// ============================================
// User & Authentication
// ============================================

model User {
  id                String           @id @default(auto()) @map("_id") @db.ObjectId
  email             String           @unique
  password          String
  passwordChangedAt DateTime?
  accountType       AccountType
  subscription      SubscriptionTier @default(free)
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt

  // Profile fields
  name              String?
  firstName         String?
  lastName          String?
  phone             String?
  timezone          String?
  locale            String?
  avatarUrl         String?
  lastLoginAt       DateTime?

  // MFA fields
  mfaEnabled        Boolean          @default(false)
  mfaSecret         String?
  mfaBackupCodes    String[]

  // Subscription & Billing
  stripeCustomerId  String?          @unique
  paypalCustomerId  String?

  // Onboarding
  onboardingCompleted Boolean        @default(false)
  onboardingStep    Int              @default(0)

  // Relations
  brandProfile      BrandProfile?
  sessions          Session[]
  memberships       Membership[]
  userSubscriptions UserSubscription[]
  paymentMethods    PaymentMethod[]
  invoices          Invoice[]
  onboardingSession OnboardingSession?
  sentInvitations   Invitation[] @relation("InvitedBy")

  // Invitation tracking
  invitedVia        String?  @db.ObjectId // Reference to invitation if user was invited

  @@map("users")
}

// ============================================
// Onboarding Session & Events
// ============================================

model OnboardingSession {
  id                    String   @id @default(auto()) @map("_id") @db.ObjectId
  userId                String   @db.ObjectId @unique
  currentStep           Int      @default(1)
  completedSteps        Int[]    @default([])
  status                String   @default("in_progress") // in_progress, completed, abandoned

  // Step data
  selectedTierId        String?
  selectedBillingCycle  String?  // monthly, yearly
  paymentMethodId       String?
  stripeCustomerId      String?
  subscriptionId        String?  @db.ObjectId
  brand360Id            String?  @db.ObjectId
  firstScanId           String?  @db.ObjectId

  // Brand setup data
  websiteUrl            String?
  brandName             String?

  // Tracking
  startedAt             DateTime @default(now())
  completedAt           DateTime?
  lastActiveAt          DateTime @default(now())

  // Resume context
  metadata              Json?

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  events                OnboardingEvent[]

  @@map("onboarding_sessions")
}

model OnboardingEvent {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  sessionId    String   @db.ObjectId
  eventType    String   // step_started, step_completed, step_skipped, error, retry, abandoned
  step         Int?
  stepName     String?  // plan_selection, payment, brand_setup, first_scan, complete
  eventData    Json?
  errorMessage String?
  createdAt    DateTime @default(now())

  session      OnboardingSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([eventType, createdAt])
  @@map("onboarding_events")
}

model Organization {
  id          String       @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  slug        String       @unique
  logo        String?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  memberships Membership[]
  invitations Invitation[]

  @@map("organizations")
}

model Membership {
  id             String   @id @default(auto()) @map("_id") @db.ObjectId
  userId         String   @db.ObjectId
  organizationId String   @db.ObjectId
  role           String   @default("MEMBER") // ADMIN, MEMBER
  status         String   @default("ACTIVE")
  invitationId   String?  @db.ObjectId // Track how member joined (null = original admin)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([userId, organizationId])
  @@map("memberships")
}

model Session {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  userId       String   @db.ObjectId
  expires      DateTime
  deviceType   String?
  ipAddress    String?
  userAgent    String?
  lastActiveAt DateTime @default(now())
  createdAt    DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, expires])
  @@map("sessions")
}

model AuditLog {
  id             String   @id @default(auto()) @map("_id") @db.ObjectId
  action         String
  category       String
  status         String
  userId         String?  @db.ObjectId
  userEmail      String?
  organizationId String?  @db.ObjectId
  targetType     String?
  targetId       String?
  description    String?
  metadata       Json?
  ipAddress      String?
  userAgent      String?
  errorMessage   String?
  createdAt      DateTime @default(now())

  @@index([userId, createdAt])
  @@index([organizationId, createdAt])
  @@index([action, createdAt])
  @@map("audit_logs")
}

// ============================================
// Team Invitations
// ============================================

model Invitation {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  email           String
  role            String   @default("MEMBER") // ADMIN, MEMBER
  status          String   @default("PENDING") // PENDING, ACCEPTED, EXPIRED, REVOKED
  token           String   @unique
  expiresAt       DateTime
  acceptedAt      DateTime?

  // Relations
  invitedById     String   @db.ObjectId
  invitedBy       User     @relation("InvitedBy", fields: [invitedById], references: [id])
  organizationId  String   @db.ObjectId
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([organizationId])
  @@index([email])
  @@index([status])
  @@map("invitations")
}

enum AccountType {
  brand
  agency
  enterprise
}

enum SubscriptionTier {
  free
  pro
  enterprise
}

// ============================================
// Brand Profile (Main entity)
// ============================================

model BrandProfile {
  id             String         @id @default(auto()) @map("_id") @db.ObjectId
  userId         String         @unique @db.ObjectId
  brandName      String
  domain         String
  descriptor     String         @default("")
  category       String         @default("General")
  competitors    String[] // Simple string array for competitor names
  crawlingStatus CrawlingStatus @default(idle)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  // Embedded documents (MongoDB-native)
  catalog      ProductCatalog?
  integrations Integrations?

  // Relations
  user               User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  brandIdentity      BrandIdentity?
  marketPosition     MarketPosition?
  competitorProfiles CompetitorProfile[]
  productDetails     ProductDetail[]
  brandAssets        BrandAsset[]
  uploadedDocuments  UploadedDocument[]

  @@map("brand_profiles")
}

enum CrawlingStatus {
  idle
  processing
  completed
  failed
}

// Embedded type for ProductCatalog
type ProductCatalog {
  products CatalogProduct[]
}

// Embedded type for simple Product (in catalog)
type CatalogProduct {
  id         String
  name       String
  category   String
  url        String
  attributes Json?
}

// Embedded type for Integrations
type Integrations {
  gsc     Boolean @default(false)
  ga4     Boolean @default(false)
  shopify Boolean @default(false)
}

// ============================================
// Brand 360 - Pillar 1: Brand Identity
// ============================================

model BrandIdentity {
  id                  String   @id @default(auto()) @map("_id") @db.ObjectId
  brandId             String   @unique @db.ObjectId
  mission             String?
  vision              String?
  values              String[]
  brandStory          String?
  uniqueSellingPoints String[]
  brandPersonality    String?
  tagline             String?
  foundedYear         Int?
  headquarters        String?

  // AI extraction metadata
  source               DataSource?
  extractionConfidence Json? // Record<string, number>
  extractedFromUrl     String?

  // Embedded document
  brandVoice BrandVoice?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relation
  brandProfile BrandProfile @relation(fields: [brandId], references: [id], onDelete: Cascade)

  @@map("brand_identities")
}

enum DataSource {
  manual
  ai_generated @map("ai-generated")
  hybrid
}

// Embedded type for BrandVoice
type BrandVoice {
  tone       String[]
  keywords   String[]
  avoidWords String[]
}

// ============================================
// Brand 360 - Pillar 2: Market Position
// ============================================

model MarketPosition {
  id                String           @id @default(auto()) @map("_id") @db.ObjectId
  brandId           String           @unique @db.ObjectId
  marketSegment     String?
  geographicMarkets String[]
  industryVerticals String[]
  marketShare       Float?
  positioning       String?
  pricingStrategy   PricingStrategy?
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt

  // Embedded documents
  targetAudiences TargetAudience[]
  marketSize      MarketSize?

  // Relation
  brandProfile BrandProfile @relation(fields: [brandId], references: [id], onDelete: Cascade)

  @@map("market_positions")
}

enum PricingStrategy {
  premium
  value
  competitive
  penetration
}

// Embedded type for TargetAudience
type TargetAudience {
  id             String
  name           String
  isPrimary      Boolean
  demographics   Demographics?
  psychographics Psychographics?
}

type Demographics {
  ageRange   String?
  gender     String?
  income     String?
  location   String[]
  occupation String[]
}

type Psychographics {
  interests  String[]
  painPoints String[]
  goals      String[]
  behaviors  String[]
}

type MarketSize {
  value    Float
  currency String
  year     Int
}

// ============================================
// Brand 360 - Pillar 3: Competitors
// ============================================

model CompetitorProfile {
  id                    String           @id @default(auto()) @map("_id") @db.ObjectId
  brandId               String           @db.ObjectId
  name                  String
  domain                String
  isPrimary             Boolean          @default(false)
  strengths             String[]
  weaknesses            String[]
  marketShare           Float?
  pricingPosition       PricingPosition?
  differentiators       String[]
  targetAudienceOverlap Float?

  // AI extraction metadata
  source             DataSource?
  competitionType    CompetitionType?
  confidenceScore    Float?
  reasonForSelection String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relation
  brandProfile BrandProfile @relation(fields: [brandId], references: [id], onDelete: Cascade)

  @@index([brandId])
  @@map("competitor_profiles")
}

enum PricingPosition {
  higher
  similar
  lower
}

enum CompetitionType {
  direct
  indirect
  aspirational
}

// ============================================
// Brand 360 - Pillar 4: Products & Services
// ============================================

model ProductDetail {
  id               String         @id @default(auto()) @map("_id") @db.ObjectId
  brandId          String         @db.ObjectId
  name             String
  sku              String?
  category         String
  subcategory      String?
  description      String         @default("")
  shortDescription String?
  features         String[]
  benefits         String[]
  useCases         String[]
  targetAudience   String[] // References to TargetAudience names
  url              String         @default("")
  imageUrls        String[]
  specifications   Json? // Record<string, string>
  awards           String[]
  certifications   String[]
  isActive         Boolean        @default(true)
  launchDate       DateTime?

  // AI extraction metadata
  source          ProductSource?
  confidenceScore Float?

  // Embedded document
  pricing Pricing?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relation
  brandProfile BrandProfile @relation(fields: [brandId], references: [id], onDelete: Cascade)

  @@index([brandId])
  @@map("product_details")
}

enum ProductSource {
  csv
  xlsx
  shopify
  website
  manual
}

// Embedded type for Pricing
type Pricing {
  currency      String
  amount        Float
  billingPeriod BillingPeriod?
}

enum BillingPeriod {
  one_time @map("one-time")
  monthly
  yearly
}

// ============================================
// Brand Assets
// ============================================

model BrandAsset {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  brandId     String    @db.ObjectId
  type        AssetType
  name        String
  description String?
  fileUrl     String?
  metadata    Json? // Type-specific metadata
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relation
  brandProfile BrandProfile @relation(fields: [brandId], references: [id], onDelete: Cascade)

  @@index([brandId])
  @@map("brand_assets")
}

enum AssetType {
  logo
  color_palette
  typography
  imagery
  document
  other
}

// ============================================
// Uploaded Documents
// ============================================

model UploadedDocument {
  id              String           @id @default(auto()) @map("_id") @db.ObjectId
  brandId         String           @db.ObjectId
  fileName        String
  fileType        DocumentType
  fileSize        Int              @default(0)
  fileUrl         String
  status          ProcessingStatus @default(pending)
  extractedData   Json? // Partial<Brand360Data>
  processingError String?
  uploadedAt      DateTime         @default(now())
  processedAt     DateTime?

  // Relation
  brandProfile BrandProfile @relation(fields: [brandId], references: [id], onDelete: Cascade)

  @@index([brandId])
  @@map("uploaded_documents")
}

enum DocumentType {
  pdf
  docx
  txt
  csv
}

enum ProcessingStatus {
  pending
  processing
  completed
  failed
}

// ============================================
// AEO ENGINE - Brand360Profile (Main Entity)
// ============================================

model Brand360Profile {
  id                String   @id @default(auto()) @map("_id") @db.ObjectId
  organizationId    String   @db.ObjectId // Links to existing BrandProfile.id

  // Basic Brand Info (for display)
  brandName         String?
  foundingYear      Int?
  founders          String[]
  values            String[]

  // Completion & Health Tracking
  completionScore   Int      @default(0)
  entityHealthScore Int      @default(0)
  lastAnalyzedAt    DateTime?
  lastAgentCrawlAt  DateTime?

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Pillar 1: Semantic Entity
  entityHome           EntityHome?
  organizationSchema   OrganizationSchema?

  // Pillar 2: Strategic Archetype
  brandIdentityPrism   BrandIdentityPrism?
  brandArchetype       BrandArchetype?
  brandVoiceProfile    BrandVoiceProfile?

  // Pillar 3: Comparative & Verified Claims
  claimLocker          ClaimLocker?
  competitorGraph      CompetitorGraph?
  riskFactors          RiskFactors?

  // Additional Relations
  customerPersonas     CustomerPersona[]
  products             Product[]
  productCatalog       AEOProductCatalog?
  generatedPrompts     GeneratedPrompt[]
  perceptionScans      PerceptionScan[]
  perceptionResults    AIPerceptionResult[]
  perceptionInsights   PerceptionInsight[]
  correctionWorkflows  CorrectionWorkflow[]

  // Target Audience & Market Positioning
  targetAudienceProfile TargetAudienceProfile?
  marketPositioning    AEOMarketPositioning?

  // Completion tracking for audience/positioning
  audienceCompletionScore    Float?   @default(0)
  positioningCompletionScore Float?   @default(0)

  @@index([organizationId])
  @@map("brand360_profiles")
}

// ============================================
// PILLAR 1: SEMANTIC ENTITY
// ============================================

// Entity Home - Knowledge Graph Foundation
model EntityHome {
  id                String   @id @default(auto()) @map("_id") @db.ObjectId
  brand360Id        String   @unique @db.ObjectId

  // Primary Identifier
  canonicalUrl      String

  // sameAs Properties - Links to authoritative sources
  wikidataId        String?
  wikipediaUrl      String?
  crunchbaseUrl     String?
  linkedinUrl       String?
  twitterUrl        String?
  facebookUrl       String?
  youtubeUrl        String?
  githubUrl         String?
  instagramUrl      String?

  // Verification Status
  wikidataVerified  Boolean  @default(false)
  schemaValidated   Boolean  @default(false)
  socialConsistent  Boolean  @default(false)

  // Knowledge Graph API Results (optional - for future use)
  googleKgId        String?
  googleKgScore     Float?
  googleKgDescription String?

  // Entity Disambiguation
  disambiguationNotes String?
  alternateNames    String[]
  formerNames       String[]

  // Health Metrics
  lastKgApiCheck    DateTime?
  kgNodeCount       Int      @default(0)

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  brand360          Brand360Profile @relation(fields: [brand360Id], references: [id], onDelete: Cascade)

  @@map("entity_homes")
}

// Organization Schema - Schema.org Compliance
model OrganizationSchema {
  id                String   @id @default(auto()) @map("_id") @db.ObjectId
  brand360Id        String   @unique @db.ObjectId

  // Schema.org @type
  organizationType  String   @default("Organization") // Organization, Corporation, LocalBusiness, etc.

  // Core Properties
  legalName         String
  name              String
  alternateName     String?
  description       String?
  slogan            String?

  // Founding Information
  foundingDate      DateTime?
  foundingLocation  String?
  founders          Json?    // [{name, url, role}]

  // Contact Points
  contactPoints     Json?    // [{type, email, phone, url}]

  // Address
  address           Json?    // {streetAddress, city, state, postalCode, country}

  // Business Details
  numberOfEmployees String?
  naicsCode         String?
  isicCode          String?

  // Awards & Recognition
  awards            String[]

  // Parent/Subsidiary Relations
  parentOrganization String?
  subOrganizations  String[]

  // Generated JSON-LD
  jsonLdOutput      Json?

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  brand360          Brand360Profile @relation(fields: [brand360Id], references: [id], onDelete: Cascade)

  @@map("organization_schemas")
}

// ============================================
// PILLAR 2: STRATEGIC ARCHETYPE
// ============================================

// Kapferer Brand Identity Prism
model BrandIdentityPrism {
  id                String   @id @default(auto()) @map("_id") @db.ObjectId
  brand360Id        String   @unique @db.ObjectId

  // 1. PHYSIQUE - Tangible, visual attributes
  physique          Json?    // {attributes: [], description}

  // 2. PERSONALITY - Aaker Brand Personality Dimensions (scored 0-100)
  personalityScores Json?    // {sincerity, excitement, competence, sophistication, ruggedness}
  personalityTraits String[]

  // 3. CULTURE - Core values and principles
  cultureValues     String[]
  cultureDescription String?

  // 4. RELATIONSHIP - Mode of interaction with customer
  relationshipType  String?
  relationshipDescription String?

  // 5. REFLECTION - Stereotypical user of the brand
  reflectionProfile Json?    // {demographics, psychographics, lifestyle}

  // 6. SELF-IMAGE - How customer sees themselves using product
  selfImage         String?

  // Prism Confidence
  inferredByAgent   Boolean  @default(false)
  confidence        Float?

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  brand360          Brand360Profile @relation(fields: [brand360Id], references: [id], onDelete: Cascade)

  @@map("brand_identity_prisms")
}

// Brand Archetypes (Jung/Mark-based)
model BrandArchetype {
  id                String   @id @default(auto()) @map("_id") @db.ObjectId
  brand360Id        String   @unique @db.ObjectId

  // Primary Archetype
  primaryArchetype  String   // innocent, sage, explorer, outlaw, magician, hero, lover, jester, everyman, caregiver, ruler, creator
  primaryScore      Int      @default(0)

  // Secondary Archetype
  secondaryArchetype String?
  secondaryScore    Int?

  // Archetype-to-Prompt Mapping
  expectedTone      String[]
  expectedDepth     String   @default("moderate") // surface, moderate, deep
  expectedCitations Boolean  @default(false)
  expectedHumor     String   @default("none") // none, subtle, prominent

  // All 12 Archetypes with scores
  archetypeScores   Json?    // {innocent, sage, explorer, outlaw, magician, hero, lover, jester, everyman, caregiver, ruler, creator}

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  brand360          Brand360Profile @relation(fields: [brand360Id], references: [id], onDelete: Cascade)

  @@map("brand_archetypes")
}

// Enhanced Brand Voice
model BrandVoiceProfile {
  id                String   @id @default(auto()) @map("_id") @db.ObjectId
  brand360Id        String   @unique @db.ObjectId

  // Voice Spectrums (scored 1-10)
  voiceSpectrums    Json?    // {formal_casual, serious_playful, respectful_irreverent, enthusiastic_matter_of_fact}

  // Tone Guidelines
  primaryTone       String?
  secondaryTones    String[]

  // Language Patterns
  vocabularyLevel   String   @default("moderate") // simple, moderate, technical, academic
  sentenceStyle     String   @default("moderate") // short_punchy, moderate, complex_nuanced

  // Do's and Don'ts
  approvedPhrases   String[]
  bannedPhrases     String[]
  bannedTopics      String[]

  // Sample Voice (for embedding comparison)
  voiceSamples      String[]

  // Vector Embedding (for similarity matching)
  voiceEmbedding    Json?

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  brand360          Brand360Profile @relation(fields: [brand360Id], references: [id], onDelete: Cascade)

  @@map("brand_voice_profiles")
}

// ============================================
// PILLAR 3: COMPARATIVE & VERIFIED CLAIMS
// ============================================

// Claim Locker Container
model ClaimLocker {
  id                String   @id @default(auto()) @map("_id") @db.ObjectId
  brand360Id        String   @unique @db.ObjectId

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  brand360          Brand360Profile @relation(fields: [brand360Id], references: [id], onDelete: Cascade)
  claims            Claim[]

  @@map("claim_lockers")
}

// Individual Verified Claims
model Claim {
  id                String   @id @default(auto()) @map("_id") @db.ObjectId
  claimLockerId     String   @db.ObjectId

  // The Claim
  claimText         String
  claimType         String   @default("feature") // feature, performance, pricing, support, award

  // Evidence
  evidenceUrl       String?
  evidenceType      String?  // case_study, whitepaper, third_party_review, benchmark
  evidenceSource    String?

  // Competitive Context
  competitorContrast String?
  comparedCompetitor String?

  // Verification
  verificationStatus String  @default("unverified") // unverified, verified, disputed
  verifiedBy        String?
  verifiedAt        DateTime?

  // Hallucination Risk Assessment
  hallucinationRisk String   @default("medium") // low, medium, high, critical
  hallucinationRiskScore Float?
  riskRationale     String?

  // Usage in Prompts
  useInPrompts      Boolean  @default(true)
  promptCategories  String[]

  isActive          Boolean  @default(true)

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  claimLocker       ClaimLocker @relation(fields: [claimLockerId], references: [id], onDelete: Cascade)

  @@index([claimLockerId])
  @@map("claims")
}

// Competitor Graph Container
model CompetitorGraph {
  id                String   @id @default(auto()) @map("_id") @db.ObjectId
  brand360Id        String   @unique @db.ObjectId

  // Auto-discovery metadata
  lastCrawled       DateTime?
  discoverySource   String?  // g2, capterra, manual, agent

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  brand360          Brand360Profile @relation(fields: [brand360Id], references: [id], onDelete: Cascade)
  competitors       Competitor[]

  @@map("competitor_graphs")
}

// Enhanced Competitor (for CompetitorGraph)
model Competitor {
  id                String   @id @default(auto()) @map("_id") @db.ObjectId
  competitorGraphId String   @db.ObjectId

  // Basic Info
  name              String
  website           String?
  description       String?
  logoUrl           String?

  // Classification
  competitorType    String   @default("direct") // direct, indirect, aspirational
  threatLevel       String   @default("medium") // low, medium, high, critical

  // Positioning
  marketPosition    String?  // leader, challenger, niche, emerging
  pricingTier       String?  // luxury, premium, mid, value, free

  // Comparative Analysis
  strengths         String[]
  weaknesses        String[]
  differentiators   Json?    // [{ours, theirs, advantage}]

  // AI Perception Tracking
  avgMentionPosition Float?
  shareOfVoice      Float?
  sentimentScore    Float?
  lastAnalyzed      DateTime?

  // Discovery Source
  discoveredBy      String   @default("manual") // manual, agent, g2, capterra
  discoveredAt      DateTime @default(now())

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  competitorGraph   CompetitorGraph @relation(fields: [competitorGraphId], references: [id], onDelete: Cascade)

  @@index([competitorGraphId])
  @@map("competitors")
}

// Risk Factors for Adversarial Prompts
model RiskFactors {
  id                String   @id @default(auto()) @map("_id") @db.ObjectId
  brand360Id        String   @unique @db.ObjectId

  // Negative Keywords & Topics
  negativeKeywords  String[]
  sensitiveTopics   String[]

  // Known Misconceptions
  commonMisconceptions String[]

  // Potential Attack Vectors
  competitorAttackClaims String[]
  pricingObjections String[]
  featureGaps       String[]

  // Crisis History
  pastCrises        Json?    // [{date, description, resolution}]

  // Guardrail Testing
  jailbreakVulnerabilities String[]

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  brand360          Brand360Profile @relation(fields: [brand360Id], references: [id], onDelete: Cascade)

  @@map("risk_factors")
}

// ============================================
// CUSTOMER PERSONAS (Enhanced)
// ============================================

model CustomerPersona {
  id                String   @id @default(auto()) @map("_id") @db.ObjectId
  brand360Id        String   @db.ObjectId

  // ---- Identity ----
  name              String   // "Marketing Mary", "Developer Dave"
  title             String?  // Job title or role
  archetype         String?  // "The Innovator", "The Pragmatist", etc.
  avatarUrl         String?
  type              String   @default("primary") // primary, secondary, tertiary, anti
  description       String?

  // ---- Demographics ----
  ageRange          String?
  gender            String?
  income            String?
  education         String?
  location          String?

  // ---- Professional Context (B2B) ----
  jobTitle          String?
  jobFunction       String?
  industry          String?
  companySize       String?  // "Startup", "SMB", "Enterprise"
  seniorityLevel    String?  // "IC", "Manager", "Director", "VP", "C-Level"
  department        String?
  reportingTo       String?  // Who they report to
  teamSize          Int?     // Number of direct reports
  budget            String?  // Budget authority level

  // ---- Psychographics ----
  personality       String?  // Brief personality description
  values            String[] // Core values
  motivations       String[] // What drives them
  frustrations      String[] // What annoys them
  aspirations       String[] // Goals and dreams
  interests         String[]
  lifestyle         String?

  // ---- Pain Points (Enhanced - now with PainPoint model relation) ----
  painPointsSummary String[] // Quick list for backward compatibility
  primaryGoals      String[] // Main objectives
  secondaryGoals    String[]
  kpis              String[] // How they measure success
  frustrationsWithCurrentSolutions String[]

  // ---- Buying Behavior ----
  buyingRole        String?  // "Decision Maker", "Influencer", "User", "Gatekeeper"
  buyingCriteria    String[] // What matters in purchase decisions
  purchaseTimeline  String?  // "Immediate", "1-3 months", "3-6 months", "6-12 months"
  budgetCycle       String?  // "Q1", "Fiscal Year End", "As needed"
  preferredVendorType String? // "Established", "Innovative", "Local"
  decisionCriteria  String[]
  decisionProcess   String?
  budgetAuthority   String?

  // ---- Information Sources ----
  informationSources String[] // Where they get info
  trustedPublications String[]
  socialPlatforms   String[]
  influencers       String[] // People/brands they follow
  communities       String[] // Slack, Discord, forums, etc.
  trustedInfluencers String[]
  contentPreferences String[]
  searchBehavior    String?

  // ---- Technology Profile ----
  techSavviness     String?  // "Low", "Medium", "High", "Expert"
  currentTools      String[] // Tools they currently use
  preferredChannels String[] // Email, Slack, Phone, etc.
  devicePreference  String?  // "Desktop", "Mobile", "Both"

  // ---- Objections & Barriers ----
  commonObjections  String[] // Typical pushback
  purchaseBarriers  String[] // What stops them from buying
  riskTolerance     String?  // "Low", "Medium", "High"

  // ---- Brand Relationship ----
  awarenessLevel    String?  // "Unaware", "Problem Aware", "Solution Aware", "Product Aware", "Most Aware"
  currentSolution   String?  // What they use today
  switchingCost     String?  // "Low", "Medium", "High"

  // ---- Messaging ----
  keyMessages       String[] // Messages that resonate
  toneThatResonates String?  // "Professional", "Casual", "Technical", etc.
  triggerWords      String[] // Words that get attention
  avoidWords        String[] // Words that turn them off

  // ---- Quotes / Voice of Customer ----
  sampleQuotes      String[] // Representative quotes

  // ---- Questions They Ask - DIRECT PROMPT FUEL ----
  commonQuestions   String[]
  objections        String[]
  buyingTriggers    String[]

  // ---- Product Mapping ----
  relevantProducts  String[] // Product IDs this persona cares about
  relevantUseCases  String[] // Use cases that matter

  // ---- Scoring ----
  priority          Int      @default(1) // 1 = Primary, 2 = Secondary, 3 = Tertiary
  revenueImpact     String?  // "High", "Medium", "Low"
  volumeImpact      String?  // "High", "Medium", "Low"
  strategicFit      Float?   // 0-100 how well they fit ideal customer profile

  // ---- Metadata ----
  importSource      String   @default("manual")
  extractionConfidence Float?
  needsReview       Boolean  @default(false)
  isActive          Boolean  @default(true)

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  brand360          Brand360Profile @relation(fields: [brand360Id], references: [id], onDelete: Cascade)
  painPoints        PainPoint[]

  @@index([brand360Id])
  @@index([priority])
  @@map("customer_personas")
}

// ============================================
// TARGET AUDIENCE & MARKET POSITIONING (Enhanced AEO)
// ============================================

// Target Audience Profile - Main container for audience data
model TargetAudienceProfile {
  id                    String   @id @default(auto()) @map("_id") @db.ObjectId
  brand360Id            String   @unique @db.ObjectId

  // Overview
  primaryMarket         String?  // B2B, B2C, B2B2C, D2C
  geographicFocus       String[] // ["North America", "Europe", "Global"]
  totalAddressableMarket String? // TAM description
  servicableMarketShare String?  // SAM/SOM description

  // Industry Verticals (for B2B)
  targetIndustries      String[]
  excludedIndustries    String[]

  // Company Size Targeting (for B2B)
  targetCompanySize     String[] // ["Startup", "SMB", "Mid-Market", "Enterprise"]
  minEmployeeCount      Int?
  maxEmployeeCount      Int?
  minRevenue            Float?
  maxRevenue            Float?
  revenueCurrency       String   @default("USD")

  // Decision Makers (for B2B)
  targetJobTitles       String[]
  targetDepartments     String[]

  // Consumer Demographics (for B2C)
  ageRangeMin           Int?
  ageRangeMax           Int?
  genderFocus           String?  // "All", "Male", "Female", "Non-binary"
  incomeLevel           String?  // "Low", "Middle", "Upper-Middle", "High", "Affluent"
  educationLevel        String?

  // Extraction metadata
  importSource          String   @default("manual") // manual, website, ai
  extractionConfidence  Float?
  lastUpdatedAt         DateTime @updatedAt

  createdAt             DateTime @default(now())

  brand360              Brand360Profile @relation(fields: [brand360Id], references: [id], onDelete: Cascade)
  segments              AEOMarketSegment[]

  @@map("target_audience_profiles")
}

// Pain Points - Critical for AEO prompt generation
model PainPoint {
  id                    String   @id @default(auto()) @map("_id") @db.ObjectId
  personaId             String   @db.ObjectId

  // Pain point details
  title                 String   // Short title
  description           String   // Full description
  category              String?  // "Efficiency", "Cost", "Quality", "Risk", etc.
  severity              String   @default("Medium") // "Critical", "High", "Medium", "Low"
  frequency             String?  // "Daily", "Weekly", "Monthly", "Occasionally"

  // Impact
  businessImpact        String?  // How it affects their business
  emotionalImpact       String?  // How it makes them feel
  currentWorkaround     String?  // How they handle it today

  // Solution mapping
  addressedByProduct    Boolean  @default(false)
  solutionDescription   String?  // How our product solves it

  // For prompt generation
  promptCategory        String?  // Which prompt category this feeds
  samplePrompts         String[] // Example prompts about this pain

  createdAt             DateTime @default(now())

  persona               CustomerPersona @relation(fields: [personaId], references: [id], onDelete: Cascade)

  @@index([personaId])
  @@index([severity])
  @@map("pain_points")
}

// Market Segments
model AEOMarketSegment {
  id                    String   @id @default(auto()) @map("_id") @db.ObjectId
  targetAudienceId      String   @db.ObjectId
  brand360Id            String   @db.ObjectId

  // Segment identity
  name                  String
  description           String?

  // Segment criteria
  segmentationType      String   // "Demographic", "Firmographic", "Behavioral", "Psychographic", "Geographic"
  criteria              Json?    // Flexible criteria definition

  // Size & opportunity
  estimatedSize         String?  // "10,000 companies", "5M consumers"
  growthRate            String?  // "15% YoY"
  marketShare           Float?   // Current market share in this segment

  // Strategic importance
  priority              Int      @default(1)
  revenueContribution   Float?   // % of revenue from this segment
  growthPotential       String?  // "High", "Medium", "Low"
  competitiveIntensity  String?  // "High", "Medium", "Low"

  // Personas in segment
  personaIds            String[] @db.ObjectId

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  targetAudience        TargetAudienceProfile @relation(fields: [targetAudienceId], references: [id], onDelete: Cascade)

  @@index([brand360Id])
  @@index([priority])
  @@map("aeo_market_segments")
}

// Market Positioning - Strategic positioning framework
model AEOMarketPositioning {
  id                    String   @id @default(auto()) @map("_id") @db.ObjectId
  brand360Id            String   @unique @db.ObjectId

  // ---- Core Positioning Statement ----
  positioningStatement  String?  // Classic positioning statement

  // ---- Positioning Components ----
  targetAudienceSummary String?  // Who we're for
  categoryDefinition    String?  // What category we compete in
  primaryBenefit        String?  // Main value we provide
  competitiveAlternative String? // What we're better than
  reasonToBelieve       String?  // Why they should believe us

  // ---- Category Strategy ----
  categoryType          String?  // "Existing", "Adjacent", "New Category"
  categoryPosition      String?  // "Leader", "Challenger", "Niche", "Disruptor"
  categoryCreation      String?  // If creating new category, describe it

  // ---- Competitive Positioning ----
  competitiveStance     String?  // "Offensive", "Defensive", "Flanking", "Guerrilla"
  primaryDifferentiator String?  // Main thing that sets us apart
  secondaryDifferentiators String[]

  // ---- Strategic Narrative ----
  beforeState           String?  // What life is like before using product
  afterState            String?  // What life is like after using product
  transformationStory   String?  // The journey from before to after

  // ---- Messaging Framework ----
  elevatorPitch         String?  // 30-second pitch
  boilerplate           String?  // Standard company description
  headlines             String[] // Key headlines/taglines

  // ---- Pricing Position ----
  pricingPosition       String?  // "Premium", "Mid-Market", "Value", "Freemium"
  pricingRationale      String?  // Why this pricing strategy

  // ---- Market Dynamics ----
  marketMaturity        String?  // "Emerging", "Growing", "Mature", "Declining"
  marketTrends          String[] // Key trends affecting positioning
  disruptionRisk        String?  // "High", "Medium", "Low"

  // ---- Metadata ----
  importSource          String   @default("manual")
  extractionConfidence  Float?
  lastReviewedAt        DateTime?

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  brand360              Brand360Profile @relation(fields: [brand360Id], references: [id], onDelete: Cascade)
  valuePropositions     ValueProposition[]
  positioningAxes       PositioningAxis[]
  proofPoints           ProofPoint[]

  @@map("aeo_market_positionings")
}

// Value Propositions
model ValueProposition {
  id                    String   @id @default(auto()) @map("_id") @db.ObjectId
  positioningId         String   @db.ObjectId

  // Core VP
  headline              String   // Compelling headline
  subheadline           String?  // Supporting statement
  description           String?  // Full description

  // Structure
  type                  String   @default("Primary") // "Primary", "Secondary", "Product-Specific"
  forPersona            String?  // Specific persona this VP is for
  forProduct            String?  // Specific product this VP is for

  // Value Framework
  functionalValue       String?  // What it does
  emotionalValue        String?  // How it makes them feel
  socialValue           String?  // How it affects their image
  economicValue         String?  // Financial benefit

  // Proof
  supportingProof       String[] // Evidence that backs this up
  customerQuote         String?  // Customer testimonial

  // Metrics (if quantifiable)
  metricValue           String?  // "50% faster", "3x ROI"
  metricContext         String?  // Context for the metric

  priority              Int      @default(1)
  isActive              Boolean  @default(true)

  createdAt             DateTime @default(now())

  positioning           AEOMarketPositioning @relation(fields: [positioningId], references: [id], onDelete: Cascade)

  @@index([positioningId])
  @@map("value_propositions")
}

// Positioning Axes - For perceptual mapping
model PositioningAxis {
  id                    String   @id @default(auto()) @map("_id") @db.ObjectId
  positioningId         String   @db.ObjectId

  // Axis definition
  name                  String   // e.g., "Ease of Use", "Price", "Features"
  description           String?

  // Axis endpoints
  lowEndLabel           String   // e.g., "Simple", "Affordable", "Basic"
  highEndLabel          String   // e.g., "Complex", "Premium", "Full-Featured"

  // Brand position on this axis (0-100)
  brandPosition         Float    // Where we sit on this axis

  // Competitor positions
  competitorPositions   Json?    // [{competitor: "X", position: 75}]

  // Strategic importance
  importance            String   @default("Medium") // "High", "Medium", "Low"
  isDefining            Boolean  @default(false) // Is this a key differentiator?

  createdAt             DateTime @default(now())

  positioning           AEOMarketPositioning @relation(fields: [positioningId], references: [id], onDelete: Cascade)

  @@index([positioningId])
  @@map("positioning_axes")
}

// Proof Points - Evidence supporting positioning claims
model ProofPoint {
  id                    String   @id @default(auto()) @map("_id") @db.ObjectId
  positioningId         String   @db.ObjectId

  // Proof content
  type                  String   // "Statistic", "Case Study", "Award", "Certification", "Testimonial", "Media Mention"
  title                 String
  description           String?

  // Metrics
  metricValue           String?  // "500+ customers", "99.9% uptime"
  metricContext         String?

  // Source
  source                String?  // Where this proof comes from
  sourceUrl             String?
  dateAchieved          DateTime?

  // Usage
  useInMessaging        Boolean  @default(true)
  primaryClaimSupported String?  // Which claim does this support

  // Verification
  isVerified            Boolean  @default(false)
  verificationNotes     String?

  priority              Int      @default(1)

  createdAt             DateTime @default(now())

  positioning           AEOMarketPositioning @relation(fields: [positioningId], references: [id], onDelete: Cascade)

  @@index([positioningId])
  @@index([type])
  @@map("proof_points")
}

// ============================================
// PRODUCT CATALOG (Enhanced)
// ============================================

model AEOProductCatalog {
  id                    String   @id @default(auto()) @map("_id") @db.ObjectId
  brand360Id            String   @unique @db.ObjectId

  // Catalog metadata
  catalogName           String
  catalogDescription    String?

  // Import source tracking
  importSource          String   @default("manual") // manual, website, shopify, csv, api
  lastImportAt          DateTime?
  lastImportSource      String?

  // Shopify connection
  shopifyConnected      Boolean  @default(false)
  shopifyStoreUrl       String?
  shopifyAccessToken    String?  // Should be encrypted in production
  shopifySyncEnabled    Boolean  @default(false)
  shopifyLastSyncAt     DateTime?

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  brand360              Brand360Profile @relation(fields: [brand360Id], references: [id], onDelete: Cascade)
  categories            AEOProductCategory[]
  products              Product[]

  @@map("aeo_product_catalogs")
}

model AEOProductCategory {
  id                    String   @id @default(auto()) @map("_id") @db.ObjectId
  catalogId             String   @db.ObjectId

  name                  String
  slug                  String
  description           String?
  parentId              String?  @db.ObjectId
  level                 Int      @default(0)
  sortOrder             Int      @default(0)

  // Schema.org mapping
  schemaType            String?  // Product, Service, SoftwareApplication, etc.

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  catalog               AEOProductCatalog @relation(fields: [catalogId], references: [id], onDelete: Cascade)
  products              Product[]

  @@unique([catalogId, slug])
  @@index([catalogId])
  @@index([parentId])
  @@map("aeo_product_categories")
}

// ============================================
// PRODUCTS (Enhanced for AEO)
// ============================================

model Product {
  id                    String   @id @default(auto()) @map("_id") @db.ObjectId
  brand360Id            String   @db.ObjectId
  catalogId             String?  @db.ObjectId
  categoryId            String?  @db.ObjectId

  // ---- Core Identity ----
  name                  String
  slug                  String?
  description           String?
  shortDescription      String?

  // ---- External IDs ----
  sku                   String?
  gtin                  String?  // Global Trade Item Number (UPC, EAN, ISBN)
  mpn                   String?  // Manufacturer Part Number
  externalId            String?  // Shopify product ID, etc.
  externalVariantId     String?  // For variant tracking

  // ---- Classification ----
  productType           String   @default("Product") // Product, Service, SoftwareApplication, Subscription
  category              String?
  subCategory           String?
  tags                  String[]

  // ---- Pricing ----
  price                 Float?
  compareAtPrice        Float?   // Original/MSRP price
  priceCurrency         String   @default("USD")
  priceRange            String?  // $, $$, $$$, $$$$
  pricingModel          String?  // one-time, subscription, freemium, usage-based
  billingPeriod         String?  // monthly, yearly, etc.

  // ---- Availability ----
  availability          String   @default("InStock") // InStock, OutOfStock, PreOrder, Discontinued
  availabilityDate      DateTime?
  inventoryQuantity     Int?

  // ---- Features & Benefits (Critical for AEO) ----
  features              String[]
  benefits              String[]
  specifications        Json?    // Technical specs as key-value

  // ---- Use Cases (Critical for Prompt Generation) ----
  useCases              String[]
  targetAudience        String?
  idealCustomer         String?

  // ---- Proof Points ----
  aggregateRating       Json?    // {ratingValue, reviewCount, bestRating}
  awards                String[]
  certifications        String[]

  // ---- Media ----
  imageUrl              String?
  imageUrls             String[]
  videoUrls             String[]

  // ---- Competitive ----
  competitorProducts    Json?    // [{competitor, product, differentiator}]
  uniqueSellingPoints   String[]

  // ---- Import Metadata ----
  importSource          String   @default("manual") // manual, website, shopify, csv
  importedAt            DateTime?
  lastSyncAt            DateTime?
  sourceUrl             String?  // Original product page URL

  // ---- Status ----
  isHero                Boolean  @default(false)
  isActive              Boolean  @default(true)
  isFeatured            Boolean  @default(false)

  // ---- AI Extraction Metadata ----
  extractionConfidence  Float?   // 0-1 confidence score
  needsReview           Boolean  @default(false)
  reviewNotes           String?

  // ---- Schema.org Output ----
  jsonLdOutput          Json?

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  brand360              Brand360Profile @relation(fields: [brand360Id], references: [id], onDelete: Cascade)
  catalog               AEOProductCatalog? @relation(fields: [catalogId], references: [id])
  categoryRef           AEOProductCategory? @relation(fields: [categoryId], references: [id])
  variants              ProductVariant[]

  @@unique([brand360Id, slug])
  @@index([brand360Id])
  @@index([catalogId])
  @@index([externalId])
  @@index([sku])
  @@map("products")
}

model ProductVariant {
  id                    String   @id @default(auto()) @map("_id") @db.ObjectId
  productId             String   @db.ObjectId

  name                  String
  sku                   String?
  externalId            String?  // Shopify variant ID

  // Variant attributes
  attributes            Json     // {size: "Large", color: "Blue"}

  // Pricing
  price                 Float?
  compareAtPrice        Float?

  // Inventory
  inventoryQuantity     Int?
  availability          String   @default("InStock")

  // Media
  imageUrl              String?

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  product               Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, externalId])
  @@index([productId])
  @@index([externalId])
  @@map("product_variants")
}

// Import job tracking
model ProductImportJob {
  id                    String   @id @default(auto()) @map("_id") @db.ObjectId
  brand360Id            String   @db.ObjectId

  // Job details
  source                String   // website, csv, xlsx, shopify
  status                String   @default("pending") // pending, processing, completed, failed, completed_with_errors

  // File details (for CSV/XLSX)
  fileName              String?
  fileUrl               String?

  // Progress
  totalItems            Int      @default(0)
  processedItems        Int      @default(0)
  successItems          Int      @default(0)
  failedItems           Int      @default(0)

  // Results
  errors                Json?    // [{row, field, error}]
  warnings              Json?    // [{row, field, warning}]

  // Timing
  startedAt             DateTime?
  completedAt           DateTime?

  createdAt             DateTime @default(now())

  @@index([brand360Id])
  @@index([status])
  @@map("product_import_jobs")
}

// ============================================
// PROMPT GENERATION ENGINE
// ============================================

model GeneratedPrompt {
  id                String   @id @default(auto()) @map("_id") @db.ObjectId
  brand360Id        String   @db.ObjectId

  // 5 Strategic Categories
  category          String   // navigational, functional, comparative, voice, adversarial
  categoryLabel     String   // The Who, The How, The Which, The Vibe, The Risk

  // Prompt Details
  intent            String   // informational, commercial, transactional, navigational
  template          String
  renderedPrompt    String

  // Targeting
  targetPersona     String?
  targetCompetitor  String?
  targetClaim       String?
  targetProduct     String?

  // Expected Response Characteristics
  expectedThemes    String[]
  expectedTone      String?
  expectedEntities  String[]
  expectedCitations Boolean  @default(false)

  // Adversarial Elements
  adversarialTwist  String?
  hallucinationTest Boolean  @default(false)

  // Metadata
  priority          Int      @default(0)
  isActive          Boolean  @default(true)
  isCustom          Boolean  @default(false)

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  brand360          Brand360Profile @relation(fields: [brand360Id], references: [id], onDelete: Cascade)
  perceptionResults AIPerceptionResult[]

  @@index([brand360Id])
  @@index([category])
  @@index([brand360Id, category, isActive])
  @@map("generated_prompts")
}

// ============================================
// PERCEPTION SCAN & RESULTS
// ============================================

model PerceptionScan {
  id                String   @id @default(auto()) @map("_id") @db.ObjectId
  brand360Id        String   @db.ObjectId

  status            String   @default("pending") // pending, running, completed, failed
  platforms         String[] // claude, chatgpt, gemini, perplexity, google_aio

  // Progress
  promptCount       Int      @default(0)
  completedCount    Int      @default(0)

  // Timing
  startedAt         DateTime?
  completedAt       DateTime?

  // Aggregated Scores
  overallScore      Float?
  platformScores    Json?    // {platform: score}

  // Quadrant Position
  quadrantPosition  String?  // dominant, vulnerable, niche, invisible

  createdAt         DateTime @default(now())

  brand360          Brand360Profile @relation(fields: [brand360Id], references: [id], onDelete: Cascade)
  results           AIPerceptionResult[]

  @@index([brand360Id])
  @@index([status])
  @@index([brand360Id, status])
  @@map("perception_scans")
}

model AIPerceptionResult {
  id                String   @id @default(auto()) @map("_id") @db.ObjectId
  promptId          String   @db.ObjectId
  brand360Id        String   @db.ObjectId
  scanId            String?  @db.ObjectId

  // Platform
  platform          String   // claude, chatgpt, gemini, perplexity, google_aio
  model             String

  // Response
  response          String
  responseTime      Int?
  tokensUsed        Int?

  // LLM-as-a-Judge Scores
  faithfulnessScore Float?
  faithfulnessErrors String[]

  // Share of Voice
  shareOfVoice      Float?
  brandMentioned    Boolean  @default(false)
  brandPosition     Int?
  competitorsMentioned String[]
  competitorPositions Json?

  // Sentiment
  overallSentiment  Float?
  aspectSentiments  Json?

  // Voice Alignment
  voiceAlignmentScore Float?
  voiceDeviations   String[]

  // Hallucination Detection
  hallucinationScore Float?
  hallucinations    String[]

  // Additional Analysis
  keyThemes         String[]
  missingInformation String[]
  opportunities     String[]

  // Visual Capture
  screenshotUrl     String?
  visualProminence  Json?

  queriedAt         DateTime @default(now())

  prompt            GeneratedPrompt @relation(fields: [promptId], references: [id], onDelete: Cascade)
  brand360          Brand360Profile @relation(fields: [brand360Id], references: [id])
  scan              PerceptionScan? @relation(fields: [scanId], references: [id])

  @@index([brand360Id])
  @@index([promptId])
  @@index([platform])
  @@index([brand360Id, platform])
  @@index([scanId, platform])
  @@map("ai_perception_results")
}

// ============================================
// INSIGHTS & AUTO-CORRECTION
// ============================================

model PerceptionInsight {
  id                String   @id @default(auto()) @map("_id") @db.ObjectId
  brand360Id        String   @db.ObjectId

  // Insight Classification
  category          String   // visibility, accuracy, sentiment, competitive, voice, hallucination
  priority          String   // critical, high, medium, low

  // The Insight
  title             String
  description       String
  impact            String

  // Recommendation
  recommendation    String
  effort            String   // low, medium, high

  // Affected Areas
  platforms         String[]
  affectedPromptCategories String[]

  // Metrics
  currentValue      Float
  targetValue       Float
  unit              String

  // Knowledge Gap Identification
  knowledgeGap      String?
  suggestedFix      String?

  // Status
  status            String   @default("open") // open, in_progress, resolved, dismissed
  resolvedAt        DateTime?
  dismissReason     String?

  // Link to Correction Workflow
  correctionWorkflowId String? @unique @db.ObjectId

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  brand360          Brand360Profile @relation(fields: [brand360Id], references: [id], onDelete: Cascade)
  correctionWorkflow CorrectionWorkflow? @relation("InsightToWorkflow", fields: [correctionWorkflowId], references: [id])

  @@index([brand360Id])
  @@index([category])
  @@index([priority])
  @@index([brand360Id, status])
  @@index([brand360Id, status, priority])
  @@map("perception_insights")
}

// Auto-Correction Workflow
model CorrectionWorkflow {
  id                String   @id @default(auto()) @map("_id") @db.ObjectId
  brand360Id        String   @db.ObjectId
  insightId         String?  @db.ObjectId

  // The Problem
  problemType       String   // hallucination, missing_info, wrong_sentiment, competitor_confusion
  problemDescription String

  // Affected Platforms
  affectedPlatforms String[]

  // Generated Fixes
  schemaOrgFix      String?
  faqPageSuggestion String?
  contentRecommendation String?
  wikipediaEditSuggestion String?

  // Implementation Status
  status            String   @default("suggested") // suggested, approved, implemented, verified
  approvedAt        DateTime?
  implementedAt     DateTime?
  verifiedAt        DateTime?
  notes             String?

  // Effectiveness Tracking
  preFixScore       Float?
  postFixScore      Float?
  improvement       Float?

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  brand360          Brand360Profile @relation(fields: [brand360Id], references: [id], onDelete: Cascade)
  insight           PerceptionInsight? @relation("InsightToWorkflow")

  @@index([brand360Id])
  @@map("correction_workflows")
}

// ============================================
// REVIEW WEBSITE INTEGRATION
// ============================================

// Review site categories (B2B Software, Consumer Electronics, etc.)
model ReviewCategory {
  id                String   @id @default(auto()) @map("_id") @db.ObjectId
  name              String   @unique
  slug              String   @unique
  description       String?
  industryKeywords  String[]

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  websites          ReviewWebsite[]
  brandMappings     BrandCategoryMapping[]

  @@map("review_categories")
}

// Individual review websites
model ReviewWebsite {
  id                String   @id @default(auto()) @map("_id") @db.ObjectId
  categoryId        String   @db.ObjectId

  name              String
  slug              String
  domain            String
  logoUrl           String?
  reviewType        String   @default("general")  // general, expert, user, aggregate
  audienceType      String   @default("mixed")    // b2b, b2c, mixed
  citationFormat    String?
  isActive          Boolean  @default(true)
  priority          Int      @default(0)

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  category          ReviewCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  promptUsages      PromptReviewSiteUsage[]

  @@unique([categoryId, slug])
  @@index([categoryId])
  @@index([isActive])
  @@map("review_websites")
}

// Maps brands to review categories
model BrandCategoryMapping {
  id                String   @id @default(auto()) @map("_id") @db.ObjectId
  brand360Id        String   @db.ObjectId
  categoryId        String   @db.ObjectId
  isPrimary         Boolean  @default(false)
  confidence        Float?
  source            String   @default("manual")  // manual, auto, ai

  createdAt         DateTime @default(now())

  category          ReviewCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([brand360Id, categoryId])
  @@index([brand360Id])
  @@map("brand_category_mappings")
}

// Tracks which review sites are used in prompts
model PromptReviewSiteUsage {
  id                String   @id @default(auto()) @map("_id") @db.ObjectId
  promptId          String   @db.ObjectId
  websiteId         String   @db.ObjectId
  citationStyle     String   @default("inline")  // inline, footnote, list

  createdAt         DateTime @default(now())

  website           ReviewWebsite @relation(fields: [websiteId], references: [id], onDelete: Cascade)

  @@unique([promptId, websiteId])
  @@index([promptId])
  @@index([websiteId])
  @@map("prompt_review_site_usages")
}

// ============================================
// PRICING & SUBSCRIPTION SYSTEM
// ============================================

model PricingTier {
  id                    String   @id @default(auto()) @map("_id") @db.ObjectId

  // Tier identification
  name                  String   @unique  // "monitor", "growth", "dominance"
  displayName           String   // "Monitor", "Growth", "Dominance"
  description           String?
  tagline               String?  // "Perfect for testing the waters"

  // Pricing
  priceMonthly          Int      // Price in cents: 9900, 29900, 99900
  priceYearly           Int?     // Annual price in cents (with discount)
  currency              String   @default("USD")

  // Stripe IDs
  stripePriceIdMonthly  String?
  stripePriceIdYearly   String?
  stripeProductId       String?

  // PayPal IDs
  paypalPlanIdMonthly   String?
  paypalPlanIdYearly    String?
  paypalProductId       String?

  // Limits
  brandLimit            Int      // 1, 10, 50
  teamSeatLimit         Int      @default(1) // 1, 2, unlimited (-1)
  competitorLimitPerBrand Int    @default(0) // 0, 3, 10
  customTopicsPerBrand  Int      @default(0) // 0, 20, 50

  // Update frequency
  updateFrequency       String   // "weekly", "daily", "realtime"

  // Feature flags
  features              Json     // Detailed feature configuration

  // Platform coverage
  platformsCovered      String[] // ["chatgpt", "perplexity", "gemini"] or ["all"]

  // Display
  isPopular             Boolean  @default(false)
  sortOrder             Int      @default(0)
  isActive              Boolean  @default(true)

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  subscriptions         UserSubscription[]

  @@map("pricing_tiers")
}

model UserSubscription {
  id                    String   @id @default(auto()) @map("_id") @db.ObjectId
  userId                String   @db.ObjectId
  organizationId        String?  @db.ObjectId
  tierId                String   @db.ObjectId

  // Status
  status                String   // "trialing", "active", "past_due", "canceled", "paused", "pending"

  // Trial
  trialStartDate        DateTime?
  trialEndDate          DateTime?
  trialDaysRemaining    Int?

  // Billing
  billingCycle          String   @default("monthly") // "monthly", "yearly"
  currentPeriodStart    DateTime?
  currentPeriodEnd      DateTime?
  cancelAtPeriodEnd     Boolean  @default(false)
  canceledAt            DateTime?

  // Stripe
  stripeSubscriptionId  String?  @unique
  stripeCustomerId      String?

  // PayPal
  paypalSubscriptionId  String?  @unique

  // Usage tracking
  brandsUsed            Int      @default(0)
  lastUsageCalculatedAt DateTime?

  // Scheduled changes (downgrade/billing cycle change)
  scheduledTierId       String?  @db.ObjectId
  scheduledBillingCycle String?

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  tier                  PricingTier @relation(fields: [tierId], references: [id])
  usageRecords          UsageRecord[]
  invoices              Invoice[]
  changes               SubscriptionChange[]
  scheduledChange       ScheduledChange?

  @@index([userId])
  @@index([status])
  @@map("user_subscriptions")
}

model PaymentMethod {
  id                    String   @id @default(auto()) @map("_id") @db.ObjectId
  userId                String   @db.ObjectId

  // Type
  type                  String   // "card", "paypal", "apple_pay", "google_pay"
  provider              String   // "stripe", "paypal"

  // Stripe
  stripePaymentMethodId String?

  // PayPal
  paypalPayerId         String?
  paypalEmail           String?

  // Card details (for display only)
  cardBrand             String?  // "visa", "mastercard", "amex"
  cardLast4             String?
  cardExpMonth          Int?
  cardExpYear           Int?

  // Wallet details
  walletType            String?  // "apple_pay", "google_pay"

  // Status
  isDefault             Boolean  @default(false)
  isActive              Boolean  @default(true)

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("payment_methods")
}

model Invoice {
  id                    String   @id @default(auto()) @map("_id") @db.ObjectId
  subscriptionId        String   @db.ObjectId
  userId                String   @db.ObjectId

  // Invoice details
  invoiceNumber         String   @unique
  status                String   // "draft", "open", "paid", "void", "uncollectible"

  // Amounts (in cents)
  subtotal              Int
  tax                   Int      @default(0)
  total                 Int
  amountPaid            Int      @default(0)
  amountDue             Int

  currency              String   @default("USD")

  // Dates
  invoiceDate           DateTime
  dueDate               DateTime?
  paidAt                DateTime?

  // Stripe
  stripeInvoiceId       String?  @unique
  stripeInvoiceUrl      String?
  stripePdfUrl          String?

  // PayPal
  paypalInvoiceId       String?

  // Line items
  lineItems             Json     // Array of line items

  createdAt             DateTime @default(now())

  subscription          UserSubscription @relation(fields: [subscriptionId], references: [id])
  user                  User     @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([subscriptionId])
  @@map("invoices")
}

model UsageRecord {
  id                    String   @id @default(auto()) @map("_id") @db.ObjectId
  subscriptionId        String   @db.ObjectId

  // Usage period
  periodStart           DateTime
  periodEnd             DateTime

  // Metrics
  brandsMonitored       Int      @default(0)
  promptsGenerated      Int      @default(0)
  scansPerformed        Int      @default(0)
  customTopicsUsed      Int      @default(0)
  apiCallsMade          Int      @default(0)

  // Limits at time of record
  brandLimit            Int

  createdAt             DateTime @default(now())

  subscription          UserSubscription @relation(fields: [subscriptionId], references: [id])

  @@index([subscriptionId])
  @@index([periodStart, periodEnd])
  @@map("usage_records")
}

// Track feature usage for fair use policy
model FeatureUsage {
  id                    String   @id @default(auto()) @map("_id") @db.ObjectId
  userId                String   @db.ObjectId
  brand360Id            String?  @db.ObjectId

  // Feature tracking
  featureName           String   // "custom_topics", "api_calls", "exports"
  usageCount            Int      @default(0)
  limitValue            Int      // The limit for this feature

  // Period
  periodType            String   // "daily", "monthly", "lifetime"
  periodStart           DateTime
  periodEnd             DateTime?

  lastUsedAt            DateTime?

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@unique([userId, brand360Id, featureName, periodStart])
  @@index([userId])
  @@map("feature_usages")
}

// ============================================
// SUBSCRIPTION CHANGE TRACKING
// ============================================

model SubscriptionChange {
  id                           String   @id @default(auto()) @map("_id") @db.ObjectId
  subscriptionId               String   @db.ObjectId
  userId                       String   @db.ObjectId

  // Change details
  changeType                   String   // "upgrade", "downgrade", "billing_cycle", "cancel", "reactivate"

  // From state
  fromTierId                   String?  @db.ObjectId
  fromTierName                 String?
  fromBillingCycle             String?
  fromPrice                    Int?     // in cents

  // To state
  toTierId                     String?  @db.ObjectId
  toTierName                   String?
  toBillingCycle               String?
  toPrice                      Int?     // in cents

  // Proration
  proratedAmount               Int?     // Amount credited/charged
  prorationDate                DateTime?

  // Timing
  effectiveDate                DateTime // When change takes effect
  isImmediate                  Boolean  @default(false)

  // Status
  status                       String   @default("pending") // "pending", "completed", "failed", "canceled"
  failureReason                String?

  // Stripe
  stripeSubscriptionScheduleId String?
  stripeProrationInvoiceId     String?

  createdAt                    DateTime @default(now())
  completedAt                  DateTime?

  subscription                 UserSubscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@index([subscriptionId])
  @@index([userId])
  @@index([status])
  @@map("subscription_changes")
}

// Scheduled downgrades (execute at period end)
model ScheduledChange {
  id                String   @id @default(auto()) @map("_id") @db.ObjectId
  subscriptionId    String   @db.ObjectId @unique

  // Scheduled change
  newTierId         String   @db.ObjectId
  newBillingCycle   String

  // Schedule
  scheduledFor      DateTime

  // Status
  status            String   @default("scheduled") // "scheduled", "executed", "canceled"

  createdAt         DateTime @default(now())

  subscription      UserSubscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@index([scheduledFor])
  @@index([status])
  @@map("scheduled_changes")
}
